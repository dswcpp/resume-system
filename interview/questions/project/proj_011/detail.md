# 分级日志系统怎么设计的？远程上报怎么做的？

## 知识点速览

分级日志系统的三个核心维度：**日志级别**（控制输出粒度）、**存储策略**（滚动、保留、压缩）、**上报机制**（远程传输、离线缓存）。

**日志级别：**

| 级别 | 用途 | 生产环境 |
|------|------|---------|
| DEBUG | 开发调试细节 | 关闭 |
| INFO | 正常运行事件（启动、连接） | 开启 |
| WARN | 潜在问题（重试、资源紧张） | 开启 |
| ERROR | 错误但可恢复（通信失败） | 开启 |

**标准日志格式：**
```
[2025-04-01 10:23:45.123] [ERROR] [DeviceManager] 设备COM3心跳超时，尝试重连(第2次)
```
包含：毫秒级时间戳、级别、模块名、具体信息。每个字段都有明确作用——时间戳用于定位、级别用于过滤、模块名用于范围缩小、信息用于理解问题。

## 我的实战经历

**公司/项目：** 江苏思行达 · 营业厅柜外交互终端

**问题背景：** 营业厅终端部署在全国各地的银行网点，设备出了问题运维人员不可能每次都到现场。初版没有系统化的日志方案——有的模块用 `qDebug()` 输出到控制台，有的写文件但格式不统一，更没有远程上报能力。设备出故障时，只能让网点工作人员描述现象，远程排查非常困难。

**设计方案：**

**1. 统一日志入口**
利用 Qt 的 `qInstallMessageHandler` 拦截所有 `qDebug/qInfo/qWarning/qCritical` 输出，统一分发到文件写入器和远程上报器：

```cpp
void customMessageHandler(QtMsgType type,
    const QMessageLogContext& ctx, const QString& msg) {
    QString formatted = formatLog(type, ctx.category, msg);
    FileWriter::instance().write(formatted);
    if (type >= QtWarningMsg) {
        RemoteReporter::instance().report(formatted);
    }
}
```

这样所有模块只需要用标准的 `qCInfo/qCWarning` 宏输出日志，不需要关心日志怎么存储和上报。

**2. 滚动策略**
- 按日滚动：每天零点切换新文件，文件名含日期（`log_2025-04-01.txt`）
- 大小限制：单文件超过10MB时也切换，避免单文件过大
- 保留策略：保留最近30天的日志，自动清理过期文件
- 嵌入式设备存储空间有限，30天 × 10MB = 最多300MB，在可控范围内

**3. 远程上报**
- 定时上传：每小时把新增日志压缩后通过MQTT推送到运维平台
- 异常触发：ERROR级别日志产生时立即上报，不等定时周期
- 离线缓存：网络不通时日志存在本地队列，网络恢复后自动补传
- 运维平台提供日志检索界面，支持按设备ID、时间范围、级别过滤

**结果：** 远程排障效率大幅提高。以前需要电话沟通半天甚至派人到现场，现在运维人员直接在平台上看日志，大部分问题10分钟内定位。ERROR级别实时上报让运维能主动发现问题，有时候网点工作人员还没感知到故障，运维已经在处理了。

## 深入原理

### 日志系统的性能考量

日志写入不能阻塞业务线程。常用方案：
1. **异步写入**：业务线程把日志放入队列，专门的写入线程消费队列写文件
2. **批量刷盘**：积累到一定量或一定时间间隔后统一flush，减少系统调用次数
3. **内存映射文件（mmap）**：写日志变成写内存，由操作系统负责刷盘

项目中采用的是方案1，用一个无锁队列缓冲日志消息，写入线程批量消费。正常情况下业务线程写日志的延迟在微秒级。

### 日志级别的运行时调整

生产环境默认INFO级别，但排查问题时需要临时开启DEBUG。实现方式：
- 配置文件修改后热加载（文件监控 `QFileSystemWatcher`）
- 远程指令下发：运维平台通过MQTT向设备发送级别调整命令
- 不需要重启程序，立即生效

### 结构化日志 vs 文本日志

文本日志可读性好但不便于机器解析。进阶方案是结构化日志（JSON格式），方便日志平台做索引和聚合分析：

```json
{"ts":"2025-04-01T10:23:45.123Z","level":"ERROR","module":"DeviceManager","msg":"心跳超时","device":"COM3","retry":2}
```

项目中文件日志用文本格式（方便现场查看），远程上报用JSON格式（方便平台分析）。

### MQTT上报的可靠性保障

MQTT支持三种QoS级别：
- QoS 0：最多一次（可能丢失）
- QoS 1：至少一次（可能重复）
- QoS 2：恰好一次（开销大）

日志上报用QoS 1——允许偶尔重复（平台做去重），但不能丢失ERROR日志。

## 面试表达建议

**开头：** "日志系统从三个维度设计：分级控制（DEBUG/INFO/WARN/ERROR），存储策略（按日滚动、10MB上限、30天保留），远程上报（MQTT定时推送 + ERROR实时上报 + 离线缓存补传）。"

**项目关联：** "营业厅终端部署在全国各网点，不可能每次到现场排查。通过远程日志上报，运维人员直接在平台上看日志，大部分问题10分钟内定位。ERROR实时上报还能主动发现问题。"

**追问准备：**
- 日志量太大怎么办？→ 控制级别、采样、结构化后聚合
- 异步写入日志会丢数据吗？→ 程序崩溃时队列中未写入的日志会丢，可以用信号处理函数在crash时flush
- 怎么防止日志撑爆磁盘？→ 大小限制 + 定时清理 + 磁盘空间监控告警
