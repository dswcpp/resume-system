# 红外模块2周从调研到交付，具体怎么做到的？

## 知识点速览

快速交付一个硬件SDK集成模块，核心方法论是**最小可行原型（MVP）驱动**：先花最短时间跑通核心链路（SDK初始化→取一帧数据→显示），验证可行性后再逐步集成到主框架。

**2周时间分配：**

| 阶段 | 天数 | 产出 |
|------|------|------|
| SDK调研 | 1-2天 | 跑通厂商Demo，确认接口可用 |
| 最小原型 | 3-4天 | 独立Demo：初始化→取图→显示 |
| 模块集成 | 5-8天 | 状态机、接口封装、伪彩图、温度追踪 |
| 联调测试 | 9-10天 | 与主框架集成、热插拔、性能验证 |

**关键技术点：** 四状态状态机管理设备连接生命周期；14bit灰度到伪彩色映射；温度标定与最高温实时追踪。

## 我的实战经历

**公司/项目：** 南京华乘 · PDS-T95手持检测终端

**背景：** 产品需要新增红外热成像检测功能，集成某厂商的红外探测器模块。从拿到SDK到功能上线总共只有2周时间，因为要赶一个客户演示节点。

**第1-2天：SDK调研**
拿到厂商提供的SDK包（头文件 + 动态库 + Demo工程），先在Windows上跑通Demo确认SDK能正常工作。重点确认三件事：图像流获取接口、温度数据读取接口、SDK对操作系统和编译器的要求。发现SDK只提供了Windows的Demo，需要自己适配到项目的嵌入式Linux环境，评估后认为接口设计合理，适配难度可控。

**第3-4天：最小原型**
写一个独立的小程序：初始化SDK → 打开设备 → 获取一帧红外图像 → 用Qt显示。这一步的目的是验证核心链路可行。遇到的问题：SDK返回的是14bit灰度数据，直接显示是黑乎乎一片，需要做灰度到伪彩色的映射。先用最简单的线性映射跑通，后续再优化色温表。

**第5-8天：模块集成**
这是工作量最大的阶段。设计了四状态状态机（Disconnected → Connecting → Connected → Error）管理设备连接生命周期，处理热插拔和异常恢复。将SDK封装为项目统一的IDetector接口实现，让上层框架不感知具体探测器类型。实现了完整的伪彩图显示——用预计算的色温映射表（铁红、彩虹等多种色板），把灰度值映射成RGB颜色。实现了温度标定和最高温追踪功能。

**第9-10天：联调测试**
与主框架集成，验证设备热插拔时状态机的正确性。发现一个bug：设备在Connected状态下被拔出，状态机没有正确转入Error状态，因为USB断开事件在某些情况下有延迟。修复方法是增加心跳检测——每秒尝试读取一帧数据，连续3次失败则判定为异常。最后做性能测试，确认帧率达标、CPU占用合理。

**结果：** 按时交付，客户演示顺利通过。后续又用了1周做优化迭代（色温表调优、UI细节调整），但核心功能在2周内全部完成。

## 深入原理

### MVP驱动的快速交付方法论

为什么先做最小原型而不是直接在主框架里开发？
1. **风险前移**：第2天就知道SDK能不能用，如果不行可以立即换方案
2. **减少干扰**：独立Demo不受主框架编译、依赖的影响，调试快
3. **增量集成**：原型验证通过后再搬进主框架，心里有底

### 14bit灰度到伪彩色映射原理

红外探测器输出的原始数据是14bit灰度值（0-16383），人眼对灰度变化不敏感，需要映射为彩色。常见色板：
- **铁红**：低温黑色→中温红色→高温白色，适合工业检测
- **彩虹**：蓝→绿→黄→红，色彩区分度高

实现方式是预计算一张256色的查找表（LUT），14bit灰度先线性压缩到8bit，再查表得到RGB值。实时帧率下查表比实时计算快得多。

### 状态机设计的通用思路

硬件设备管理几乎都需要状态机。设计步骤：
1. 列出所有可能的状态
2. 画出所有合法的状态转换路径
3. 明确每个转换的触发条件和执行动作
4. 处理异常路径（超时、错误恢复、重连策略）

状态机让设备管理代码结构清晰，避免各种if-else嵌套，也便于添加新状态。

## 面试表达建议

**开头：** "2周分四个阶段：2天SDK调研跑通Demo，2天做最小原型验证核心链路，4天模块集成包括状态机和伪彩图实现，2天联调测试。核心方法论是MVP驱动——先用最短时间验证可行性，再逐步集成。"

**重点讲做法：** "我先在独立Demo里跑通SDK→取图→显示的核心链路，确认可行后才搬进主框架。设计了四状态状态机管理设备连接，用预计算色温查找表实现伪彩图实时显示。"

**追问准备：**
- 如果SDK有bug怎么办？→ 调研阶段就会发现，及时联系厂商或准备备选方案
- 2周够吗，质量能保证吗？→ 先交付核心功能，后续迭代优化；MVP不等于粗糙，而是聚焦
- 状态机为什么是四个状态？→ 覆盖设备生命周期的关键节点，太少不够用，太多增加复杂度
