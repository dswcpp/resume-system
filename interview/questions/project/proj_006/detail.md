# 如果让你从零设计一个数据采集软件，怎么设计架构？

## 知识点速览

数据采集软件的架构设计遵循**分层解耦**原则：硬件层 → 驱动层 → 服务层 → 业务层 → 应用层。每层通过接口通信，上层不依赖下层实现细节。线程模型上，采集、处理、存储、显示各在独立线程，用队列解耦。

**核心设计模式：**
- 工厂模式：设备创建
- 策略模式：可插拔的处理器
- 观察者模式：数据分发（发布-订阅）
- 管线模式：数据处理流水线

## 我的实战经历

**综合经验：** 南京华乘 T95（多检测模块数据采集） + 思行达柜外终端（多设备对接）

**回答框架（面试现场版）：**

**第一步：需求澄清**

"在设计之前，我会先问清楚几个关键问题：采集什么数据？数据量多大？实时性要求多高？需不需要存储？有几个数据源？运行在什么平台？"

这些问题直接影响设计决策。比如 1KB/s 和 100MB/s 的架构完全不同，单数据源和多数据源的线程模型也不同。

**第二步：分层架构设计**

假设场景：多个传感器（温度、压力、振动），采样率 100Hz~10kHz，需要实时显示和存储。

五层架构：

1. **硬件层**：传感器、采集卡、通信接口（串口/USB/网口）
2. **驱动层**：抽象设备接口

```cpp
class IDevice {
public:
    virtual bool open() = 0;
    virtual void close() = 0;
    virtual bool configure(const DeviceConfig& config) = 0;
};

class IAcquisitionDevice : public IDevice {
public:
    virtual bool startAcquisition() = 0;
    virtual void stopAcquisition() = 0;
    virtual void setSampleRate(double rate) = 0;
signals:
    void dataReady(const AcquisitionData& data);
};
```

不同设备（串口设备、USB 设备、网口设备）各自继承实现，DeviceFactory 工厂创建。

3. **服务层**：AcquisitionManager 统一管理所有设备、DataDistributor 发布-订阅分发数据
4. **业务层**：ProcessingPipeline 处理管线（可插拔 IProcessor）、StorageManager 异步存储
5. **应用层**：UI 显示、报警、报表

**第三步：线程模型设计**

每个采集设备一个线程，处理管线独立线程，存储独立线程，UI 主线程。线程间用 SPSC 无锁队列连接：

```
采集线程1 ──┐
             ├──→ [队列] ──→ 处理线程 ──→ [队列] ──→ UI主线程
采集线程2 ──┘                    │
                                 └──→ [队列] ──→ 存储线程
```

**第四步：关键技术决策**

- **数据格式**：统一的 DataPacket 结构（时间戳 + 通道 ID + 数据 + 元信息）
- **队列选型**：SPSC 无锁队列（单生产单消费场景）
- **存储方案**：高频数据用二进制文件，元信息用 SQLite
- **配置管理**：JSON 配置文件驱动，支持运行时重载
- **错误处理**：设备断开自动重连、数据溢出清理缓冲区、存储失败切备用路径

**第五步：扩展性考虑**

- 新设备：实现 IAcquisitionDevice 接口，注册到工厂即可
- 新处理器：实现 IProcessor 接口，加到管线配置
- 新存储后端：实现 IDataStore 接口
- 全部配置文件驱动，不改代码

**结合实际项目经验：**

"这个架构不是凭空想的。在 T95 项目中，我设计了 IDetectionModule 接口和模块化框架，就是这个思路——集成周期从 3 个月缩短到 50 天。在思行达做柜外终端时，15+ 种设备用适配器模式即插即用，也验证了工厂+接口的扩展性。"

## 深入原理

### 关键追问预备

**Q：如果数据量很大怎么办？**
- 采集层：增大缓冲区，允许丢帧
- 处理层：降采样、抽取关键帧
- 存储层：分文件存储、压缩
- 显示层：控频刷新、抽稀显示

**Q：怎么保证不丢数据？**
- 队列深度根据最大延迟计算
- 监控队列使用率预警
- 关键数据优先处理
- 持久化到磁盘保证不丢

**Q：多个设备时间怎么同步？**
- 主机时间戳：采集时由主机统一打时间戳
- 硬件同步：用外部触发信号（精度更高但需硬件支持）
- 软件对齐：根据时间戳就近匹配

### 为什么选分层架构而非微服务？

数据采集软件通常是单机应用，分层架构简单直接。微服务适合分布式系统，引入网络通信和服务发现的复杂度，对实时性也有影响。如果未来需要分布式部署，可以在服务层加网络层适配。

## 面试表达建议

**开头展示系统思维：** "在设计之前，我会先问清楚需求——数据量、实时性、数据源数量这些直接影响架构选型。"

**中间用五层架构展开：** 从下到上讲，每层一两句话概括职责和关键设计。不要跳到代码细节，保持在架构层面。

**结尾结合实际经验：** "这个架构在我做 T95 和柜外终端时都实践验证过。T95 用 IDetectionModule 接口让集成周期缩短了一半多，柜外终端用适配器模式支持了 15+ 种设备即插即用。"

**画图辅助：** 面试时可以在纸上画五层架构图和线程模型图，直观清晰。
