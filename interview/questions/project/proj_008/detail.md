# 你在项目中遇到的最有挑战性的技术问题是什么？

## 回答框架

技术挑战类问题用完整的 **STAR 结构**讲述，关键是：(1) 制造紧迫感说明问题严重性；(2) 展示分析定位的思考过程；(3) 方案选型的理由；(4) 量化结果；(5) 总结教训。

## 我的实战经历

**公司/项目：** 南京华乘电气 · T95 带电检测手持终端

**情境（Situation）：**
去年 T95 带电检测终端上线后，现场工程师频繁反馈**界面非常卡顿**——特别是 UHF 超高频检测模式下，波形图刷新明显掉帧，有时候出现 1-2 秒的"假死"。这个问题很严重：电力检测需要实时观察波形变化来判断设备故障，卡顿直接影响检测准确性。客户已经开始抱怨，领导把这个问题作为最高优先级交给我。

**任务（Task）：**
1. 定位卡顿的根本原因
2. 提出解决方案并实施
3. 确保不影响数据采集的完整性（不能为了 UI 流畅而丢关键检测数据）

难点在于：系统已经在生产环境运行，不能停机大改架构，而且多个检测模块同时工作，改一处可能影响其他模块。

**行动（Action）：**

**第一步：数据驱动定位问题**

我没有凭直觉猜，而是用 Qt Creator 的 Profiler 做了完整的性能分析：

- **锁等待时间占 CPU 的 20% 以上** —— 这是最明显的异常
- 数据采集线程和 UI 刷新线程在频繁争抢同一把 `QMutex`
- UHF 模式下数据量最大（1MHz 采样率），锁竞争最严重

原来的设计：采集线程每次拿到数据就加锁写入缓冲区，UI 线程定时加锁读取。UHF 模式下每秒 1000 次 push、1000 次 pop，共 2000 次锁操作。

同时发现另外两个问题：
- UI 线程被动响应——每来一帧数据就刷新一次，但屏幕才 60Hz
- 每次刷新都深拷贝整个数据包

**第二步：方案设计与选型**

分析场景后发现是"一个采集线程写、一个 UI 线程读"——典型的 SPSC 场景。查阅了 Lamport 的论文和 folly 的 ProducerConsumerQueue 实现后，决定用 SPSC 无锁队列替代 mutex。

为什么选 SPSC 无锁而非其他方案？
- boost::lockfree：可以用，但引入外部依赖，且我们场景简单不需要通用方案
- Qt 信号槽：底层也是队列但有类型擦除开销，性能不够
- MPMC 无锁：过于复杂，我们不需要多生产者多消费者

配合两个辅助优化：
- **控频刷新**：UI 改为 30Hz 定时拉取最新帧，不再被动响应
- **shared_ptr 零拷贝**：传指针不传数据

**第三步：分阶段实施**

考虑到系统已在线上运行，不能一次性全改。制定了分阶段计划：
1. 先在 UHF 模块（卡顿最严重）上替换，旧代码保留可回滚
2. 观察一周，对比性能数据确认改善
3. 推广到 TEV、AE、红外模块
4. 全部稳定后删除旧的加锁队列代码

每个阶段都有明确的性能指标对比：延迟、CPU 占用、帧率。

**结果（Result）：**

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| UI 刷新延迟 | 200ms | 50ms |
| CPU 占用率 | 85% | 45% |
| UHF 波形帧率 | 不稳定，经常掉帧 | 稳定 30fps |
| 切换模式卡顿 | 1-2 秒 | 无感知 |
| 用户体验反馈 | "经常卡死" | "很丝滑" |

客户反馈界面"丝滑"了很多，这个优化后来也被应用到了所有检测模块，成为团队的标准方案。

**我从这个问题学到的：**
1. **性能问题用数据说话，不能靠猜** —— Profiler 直接指出了锁竞争是瓶颈
2. **无锁编程在特定场景效果显著** —— SPSC 场景下吞吐量提升 20 倍
3. **线上系统改动要小步快跑** —— 分模块上线、可回滚、有对比数据
4. **方案选型要匹配场景** —— 不是最复杂的方案最好，SPSC 比 MPMC 简单得多但恰好够用

## 延伸思考

### 如果无锁队列也不够用怎么办？

如果数据量再大一个数量级，单纯的 SPSC 队列可能不够。可以考虑：
- 多级队列：采集→预处理→分析→显示，每级独立队列
- 降采样：UI 不需要全部数据
- GPU 渲染：把图谱渲染卸载到 GPU
- 实际上 T95 后来的流水线架构就是这个方向

### 如何预防类似问题？

- 建立性能基线：每个版本跑 benchmark
- CI 集成性能测试：性能回退自动报警
- Code Review 关注性能：高频路径禁止加锁

## 面试表达建议

**开头制造紧迫感（10 秒）：** "T95 上线后客户反馈界面卡顿很严重，UHF 检测模式下经常假死。电力检测需要实时看波形，卡顿影响故障判断，客户已经在抱怨了。"

**定位过程（30 秒）：** "我用 Profiler 分析，发现锁等待占了 CPU 20% 以上。采集线程 1000Hz 写、UI 线程 30Hz 读，mutex 争抢非常严重。"

**解决方案（1 分钟）：** "场景恰好是单生产单消费，用 SPSC 无锁队列替代 mutex。配合控频刷新和零拷贝。分模块上线，先 UHF 后其他。"

**结果（10 秒）：** "延迟从 200ms 降到 50ms，CPU 从 85% 降到 45%，客户反馈很丝滑。"

**升华（10 秒）：** "学到性能问题要用数据定位，方案要匹配场景，线上改动要小步快跑。"
