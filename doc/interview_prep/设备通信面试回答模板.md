# 设备通信（串口/USB/RS485/Modbus）面试回答模板（可直接背/灵活删减）

## 一、串口 / USB 通信

### 1）面试官常问什么？

- 串口通信的基本参数有哪些？
- 你是怎么设计串口/USB 的通信协议的？
- 如何处理丢包、校验、超时重发？

### 2）基本概念

> 在设备通信这一块，我用得最多的是串口（包括 RS232/TTL）和 USB 虚拟串口。
> 串口比较核心的参数是：波特率、数据位、停止位、校验位和流控，两端要保持一致才能正常通信。USB 这边很多工业设备其实是通过 USB 转串口芯片（如 CH340/FTDI）暴露成虚拟串口来用，应用层看起来和普通 COM 口差不多。

### 3）应用层协议设计（粘包、校验、命令）

- 设计统一帧格式，解决粘包、错包与校验：
  - 帧头（魔数/同步字，如 0x55AA）、地址/设备 ID、命令字、长度、数据区、CRC 校验。
- 接收端维护接收缓冲区，用状态机解析：先找帧头→读长度→校验 CRC→通过后交给上层处理；否则丢弃并继续同步。
- 该套设计在串口与 USB 虚拟串口上通用。

### 4）项目例子（可直接使用）

- 在 PCB 喷码机 / 激光二维码打印项目 与 带电检测手持终端 中，上位机与控制器通过串口/USB 协议通信：
  - 上位机通过串口发送“开始打印”“停止”“设置参数”“读取状态”等命令；
  - 控制器按自定义帧格式返回当前状态与告警信息。
- 协议解析实现为独立“接收状态机模块”，上层只关心命令结果；底层封装粘包拆包、CRC 校验、超时重试，整体更稳定、便于扩展指令集。

---

## 二、RS485 通信

### 1）常见提问

- RS485 与 RS232 的区别？
- 485 总线如何避免冲突？
- 终端电阻、差分信号等基本概念？

### 2）概括（差分 + 总线 + 半双工）

- RS485 是电气层标准，区别于 RS232：
  - 差分信号（A/B 线），抗干扰强，适合长距离与工业现场；
  - 支持多点总线拓扑，一主多从；
  - 半双工，需控制收发方向（芯片 DE/RE）。
- 软件层面通常主站轮询各从站，避免从站同时发数据造成总线冲突。

### 3）轮询 + 防冲突 + 抗干扰

- 协议设计：
  - 每个从设备分配唯一地址 ID；
  - 主站按周期轮询：发请求→等响应→超时重试或标记离线；
  - 严控仅被轮询到的从站才可发数据。
- 抗干扰：
  - 帧内加入 CRC16 校验；
  - 异常电平/异常长度帧直接丢弃；
  - 软件层做重发与错误计数，超阈值上报告警。

### 4）项目落地

- 在 营业厅智能运营管理平台 与设备上位机 项目中，使用 RS485 接 PLC/传感器：
  - 设计轮询与超时重试策略；
  - 通过 CRC 校验 + 超时重发 + 轮询间隔控制，在强干扰现场保持较高通信成功率，异常可快速定位到线路或设备。

---

## 三、Modbus（重点 RTU）

### 1）常见提问

- 什么是 Modbus？RTU 与 TCP 区别？
- Modbus RTU 报文结构？
- 代码实现思路？

### 2）定义与场景

- Modbus 是工业领域常见的主从式通信协议：
  - Modbus RTU 跑在串口/RS485 上；
  - Modbus TCP 跑在 TCP/IP 之上。
- 抽象了寄存器读写协议：从站地址、功能码、寄存器地址、数据格式等。

### 3）Modbus RTU 报文结构

- 一帧包含：
  - 从站地址（1 字节）
  - 功能码（1 字节，如 0x03 读保持寄存器）
  - 数据区（寄存器地址、高低字节、数量等）
  - CRC16 校验（低字节在前，高字节在后）
- 典型主从轮询模式：主站请求、从站响应，读/写寄存器实现设备监控与控制。

### 4）代码实现要点

- 封装帧构造/解析模块：根据地址、功能码、寄存器地址和数量拼完整请求帧并计算 CRC。
- 通过串口或 TCP 发送帧，启超时定时器；
- 收到响应后校验 CRC、判断功能码（异常响应功能码 = 原码 + 0x80），解析寄存器数据并转换工程量；
- 上层提供 `readRegisters(addr, startReg, count)` 等接口，屏蔽底层帧细节；
- 超时或 CRC 错误：设定重试次数并记录错误计数，用于线路质量或设备异常判断。

### 5）项目挂钩

- 接入电力/工控设备时遇到仅提供 Modbus RTU 的情况：
  - 根据对方寄存器表，用结构体或配置文件描述寄存器含义与数量；
  - 在串口通信模块里集成 Modbus 打包/解析；
  - 上层仅关注读到的工程量（电压/电流/温度等）；
  - 通过该封装，底层设备可被替换，只要支持 Modbus 即可快速集成。

---

## 四、两三分钟“设备通信综合回答”

> 我主要做过串口/USB 虚拟串口、RS485 总线以及基于 Modbus 的主从通信。串口与 USB 应用层近似，先按设备手册配置波特率、数据位、校验位等，再在应用层设计带帧头、长度、命令字与 CRC 的帧格式，接收端用状态机解决粘包/半包。在 PCB 喷码机与带电检测终端中，上位机通过串口或 USB 虚拟串口向控制器发送指令，控制器按协议返回状态与告警；协议解析封装为独立模块，上层只看业务结果，底层负责拆包、校验与超时重试，系统稳定性显著提升。RS485 采用差分信号，适合工业现场，支持一主多从且为半双工，因此用地址与轮询避免总线冲突，并在帧内加入 CRC16 与重试策略提升鲁棒性。Modbus（尤其 RTU）在 RS485 上定义了统一寄存器读写协议，典型帧包含从站地址、功能码、寄存器地址与数量、数据区、CRC16；实现上封装帧构造与解析，提供 `readRegisters`/`writeSingleRegister` 等接口让上层只关注工程量。总体关注链路参数配置、应用层协议设计（帧格式/拆包/CRC）、轮询与重试策略，以及现场环境下的鲁棒性，这些在我做 PCB 喷码机、柜外交互终端、营业厅智能运营平台与带电检测终端中都有实践。